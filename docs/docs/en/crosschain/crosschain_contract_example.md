# 跨链合约编写及操作示例

## 跨链合约编写

### 跨链合约示例

[示例](https://github.com/cryptape/cita/blob/develop/scripts/contracts/tests/contracts/cross_chain_token.sol)

这是一个可以跨链转移token的Token合约。

相比普通的Token合约增加了 `send_to_side_chain` 和 `recv_from_side_chain` 两个函数用于跨链转token。

`send_to_side_chain` 只是在一条链上扣掉一部分token。

等交易执行之后，使用 JsonRPC 接口 `cita_getTransactionProof` 获取交易执行的证明。

将证明发送到另外一个链上的 `recv_from_side_chain`。校验证明之后解析出原始交易的内容。在这个例子里就是转账金额。

然后执行整个交易的后半段，给同样的用户增加同样数量的token。完成token的跨链转移。

### 跨链合约注意事项

`RECV_FUNC_HASHER` 是 `recv_from_side_chain` 的function signature。可以使用如下命令查看：
```shell
# solc cross_chain_token.sol --hash
======= cross_chain_token.sol:MyToken =======
Function signatures:
70a08231: balanceOf(address)
f7407178: get_banlance(address)
5999917c: get_cross_chain_nonce()
ec90a79a: recv_from_side_chain(uint256,bytes)
4c6e5926: send_to_side_chain(uint256,address,uint256)
a9059cbb: transfer(address,uint256)
```

`DATA_SIZE` 是跨链传递的数据的大小。即 `send_to_side_chain` 除去前两个参数（固定必须的参数）之后所有参数的总大小。

`nonce` 是为了防止跨链交易重放攻击增加的，作用同`CITA`交易中的nonce。

跨链交易必须严格按照交易发生的顺序在两条链之间传递，因此 `crosschain_nonce` 设计为自增的计数。

将证明发送到另外一个链上之前，先调用 `get_cross_chain_nonce` 获取当前 `nonce`。

同时有工具可以解析证明，提取证明中的 `nonce`。只有两者相等才能发送成功，如果不相等，则说明证明已经发送过，可以丢弃；或者前序交易还未发送，还需要等待。

`send_to_side_chain` 中的 `event cross_chain(uint256 from_chain_id, uint256 to_chain_id, address dest_contract, uint256 hasher, uint256 nonce);`为跨链提供必须的信息。

请勿修改，也不要在这个函数中增加其他 `event`。

`recv_from_side_chain` 解析出原始交易的数据为 `bytes` 类型，用户需要参照 `send_to_side_chain` 自行解析成对应的类型。

## 跨链合约操作示例

多链部署以及相关的管理功能尚未完成，当前示例是在同一条链上操作的，即从chain 0 跨链到它本身。

### 部署合约

```shell
# cd scripts/txtool/txtool
# python make_tx.py --privkey "352416e1c910e413768c51390dfd791b414212b7b4fe6b1a18f58007fa894214" --code "606060405263ec90a79a6003556020600455341561001c57600080fd5b60646000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000208190555061073c8061006f6000396000f300606060405260043610610078576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680634c6e59261461007d5780635999917c146100c857806370a08231146100f1578063a9059cbb1461013e578063ec90a79a14610180578063f7407178146101e6575b600080fd5b341561008857600080fd5b6100c6600480803590602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610233565b005b34156100d357600080fd5b6100db610364565b6040518082815260200191505060405180910390f35b34156100fc57600080fd5b610128600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190505061036e565b6040518082815260200191505060405180910390f35b341561014957600080fd5b61017e600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035906020019091905050610386565b005b341561018b57600080fd5b6101e4600480803590602001909190803590602001908201803590602001908080601f016020809104026020016040519081016040528093929190818152602001838380828437820191505050505050919050506104fc565b005b34156101f157600080fd5b61021d600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506106b4565b6040518082815260200191505060405180910390f35b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020541015151561028057600080fd5b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825403925050819055507f02d96cafa1b66d774136b3051a7a5675d5cb23a055bfe1410019ec924f4f93ac60008484600354600154604051808681526020018581526020018473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018381526020018281526020019550505050505060405180910390a16001805401600181905550505050565b6000600254905090565b60006020528060005260406000206000915090505481565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054101515156103d357600080fd5b6000808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054816000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002054011015151561046057600080fd5b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008282540392505081905550806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082825401925050819055505050565b600080600080600061050c6106fc565b6000806003549750600254965089955060045493508360405180591061052f5750595b9080825280601f01601f19166020018201604052509250604051600081523060048201528860248201528760448201528660648201526024360360246084830137602085018160603601836000611301620186a0f16000811461059e5781519650856020863e816040526105a3565b600080fd5b50506001600254016002819055507f9c312d9fd3ecd3b5e58f9cd24950559f7765c7ee98e7e7783a61efb8ee696ad585846040518083815260200180602001828103825283818151815260200191508051906020019080838360005b8381101561061a5780820151818401526020810190506105ff565b50505050905090810190601f1680156106475780820380516001836020036101000a031916815260200191505b50935050505060405180910390a184915082519050806000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020016000206000828254019250508190555050505050505050505050565b60008060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020549050919050565b6020604051908101604052806000815250905600a165627a7a72305820675ab42d5362bc1acd113cfbd3e2887b041b686bf11f29ef78b0f7ab6ce18d520029"
# python send_tx.py
# python get_receipt.py
{
  "contractAddress": "0x73552bc4e960a1d53013b40074569ea05b950b4d",
  "cumulativeGasUsed": "0x693a7",
  "logs": [],
  "blockHash": "0x3d38ff8c14dbebba5cf012008949ecb8cd5c151c2a951016cb0ea6d497f69631",
  "transactionHash": "0x4ff179618cacc2f9c07b61327140ab8c6af5c6c185ac7f970574ebbb3fc90c5f",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x7",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x693a7"
}
```
查询一下当前用户的token数量。
```shell
//call get_banlance
# curl -X POST --data '{"jsonrpc":"2.0","method":"eth_call", "params":[{"from":"0dbd369a741319fa5107733e2c9db9929093e3c7","to":"0x73552bc4e960a1d53013b40074569ea05b950b4d","data":"0xf74071780000000000000000000000000dbd369a741319fa5107733e2c9db9929093e3c7"}],"id":2}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000064"}
```
token数量为合约初始化时设置的100个。

### 发送跨链交易

```shell
// send_to_side_chain(0, contractAddress, 2)
# python make_tx.py --privkey "352416e1c910e413768c51390dfd791b414212b7b4fe6b1a18f58007fa894214" --to "73552bc4e960a1d53013b40074569ea05b950b4d" --code "4c6e5926000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d0000000000000000000000000000000000000000000000000000000000000002"
# python send_tx.py
# python get_receipt.py
{
  "contractAddress": null,
  "cumulativeGasUsed": "0x6d7b",
  "logs": [
    {
      "blockHash": "0xbf9c2df6b295445999cb2ad61fd10ef3f5c9c366fb21eb0fc10b6aff207eee1c",
      "transactionHash": "0x37f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4",
      "transactionIndex": "0x0",
      "topics": [
        "0x02d96cafa1b66d774136b3051a7a5675d5cb23a055bfe1410019ec924f4f93ac"
      ],
      "blockNumber": "0x5b",
      "address": "0x73552bc4e960a1d53013b40074569ea05b950b4d",
      "transactionLogIndex": "0x0",
      "logIndex": "0x0",
      "data": "0x0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d00000000000000000000000000000000000000000000000000000000ec90a79a0000000000000000000000000000000000000000000000000000000000000000"
    }
  ],
  "blockHash": "0xbf9c2df6b295445999cb2ad61fd10ef3f5c9c366fb21eb0fc10b6aff207eee1c",
  "transactionHash": "0x37f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x5b",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000040000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x6d7b"
}
```

查询一下当前用户的token数量。
```shell
//call get_banlance
# curl -X POST --data '{"jsonrpc":"2.0","method":"eth_call", "params":[{"from":"0dbd369a741319fa5107733e2c9db9929093e3c7","to":"0x73552bc4e960a1d53013b40074569ea05b950b4d","data":"0xf74071780000000000000000000000000dbd369a741319fa5107733e2c9db9929093e3c7"}],"id":2}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000062"}
```
转走2个token之后数量为98个。

### 获取交易证明

```shell
// get transaction proof by transactionHash
# curl -X POST --data '{"jsonrpc":"2.0","method":"cita_getTransactionProof","params":["0x37f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4"],"id":1}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":1,"result":"0xf9070df903f2a09a9102d68052de36b825d5b1f4dc9512684a8b1a61add6337e455ef69eb304e7a044d0da81e6ebd0928c084692e5aacb6f0e56dbd0a064c9639adb7ef9f6fd3b41a037f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4a02c533219294c9fce960e0749b017a3ce281eb45facaa138123240336fef8327db90100000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000400000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000005b88ffffffffffffffff826d7b86016242114b6f80b902530ace0442000000000000003078306139383765623937646438323539626433623063386665303832303333333762336631386536613161653735613035636261383032336135346563303564355a00000000000000000000000000000004000000000000002a000000000000003078316666333830313730633765633338613831643731636663636433343765653033386464646237304100000000000000cf81312f4118a72b53f35ecd99817cb499597f1ff7132df672e58cbb615180e8535eebe2040d6303b50c55cbe01d01de49512b6dbffc363dd950a4a919b9693b002a000000000000003078383665373133326164326535323433326466323537633630373638373962626334393962343365624100000000000000f75f5b766676560d6e1a116c29ac6176070c5448c453dc68202b4ac7d388c3cc0edf07d2e0c171710c6ec30735d06590b7fa8e3c094a9275df1bfddf026f1a94002a000000000000003078373661393566333633313532666133353338623530366362636539333764343138613164643131644100000000000000cba1c56842458c11245ba64b0fc3f93dc90682b12407623634433a6a22a741af356a2df0603ab6d300b7c8638db7c56761a716d4948da10be177b36193c058e7012a0000000000000030783362313836653138643263353530383661343230323338373239613238303761393364366163633941000000000000000727955db4413d3c7f476d94d7570ae6d6ed4177fff682fde08ee21b1e46e47073d39d22218b55bb56e1e620fb4a5f17c998d9b80892a27fd73d947756483085001002f901e5826d7bb9010000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000040000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000f8dbf8d99473552bc4e960a1d53013b40074569ea05b950b4de1a002d96cafa1b66d774136b3051a7a5675d5cb23a055bfe1410019ec924f4f93acb8a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d00000000000000000000000000000000000000000000000000000000ec90a79a0000000000000000000000000000000000000000000000000000000000000000c001c0f9012c31808398967f9473552bc4e960a1d53013b40074569ea05b950b4d80b8644c6e5926000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d000000000000000000000000000000000000000000000000000000000000000281aeb84182e91042d0201d5f3c8def6f7b09a46a02c6d4a9890e878406498f47fc78719a6d86ee0cfb7bba33228649790c7340ea975dbe59b7fd6a0f267de972b1008dbf0180a037f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4b840c7561cde2792e85c76bf423cf9c339bd085f6ca686e2fe5cb5092c6bff210786790cac0bf6472e6837282bef5e19416e791f5dbf6abbb33e04e4b291d6ef4e1b80"}
```

计算证明长度为`0x710`。

将来提供工具解析证明中的信息，跨到哪条链，合约地址，合约函数hasher，nonce的值等。不过这里只是示例不需要这些信息。

### 发送证明到目标链上

查询目标链上对应合约的nonce值。

```shell
//call get_cross_chain_nonce
curl -X POST --data '{"jsonrpc":"2.0","method":"eth_call", "params":[{"from":"0dbd369a741319fa5107733e2c9db9929093e3c7","to":"0x73552bc4e960a1d53013b40074569ea05b950b4d","data":"0x5999917c"}],"id":2}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000000"}
```

发送证明到 `recv_from_side_chain`
```shell
// call recv_from_side_chain(proof_len, proof)
python make_tx.py --privkey "352416e1c910e413768c51390dfd791b414212b7b4fe6b1a18f58007fa894214" --to "73552bc4e960a1d53013b40074569ea05b950b4d" --code "ec90a79a0000000000000000000000000000000000000000000000000000000000000710f9070df903f2a09a9102d68052de36b825d5b1f4dc9512684a8b1a61add6337e455ef69eb304e7a044d0da81e6ebd0928c084692e5aacb6f0e56dbd0a064c9639adb7ef9f6fd3b41a037f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4a02c533219294c9fce960e0749b017a3ce281eb45facaa138123240336fef8327db90100000000000000000000000000000000000000000000000000000000000000000000000000000800000000000000000000000400000000000000000000000000800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000800000000000040000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000005b88ffffffffffffffff826d7b86016242114b6f80b902530ace0442000000000000003078306139383765623937646438323539626433623063386665303832303333333762336631386536613161653735613035636261383032336135346563303564355a00000000000000000000000000000004000000000000002a000000000000003078316666333830313730633765633338613831643731636663636433343765653033386464646237304100000000000000cf81312f4118a72b53f35ecd99817cb499597f1ff7132df672e58cbb615180e8535eebe2040d6303b50c55cbe01d01de49512b6dbffc363dd950a4a919b9693b002a000000000000003078383665373133326164326535323433326466323537633630373638373962626334393962343365624100000000000000f75f5b766676560d6e1a116c29ac6176070c5448c453dc68202b4ac7d388c3cc0edf07d2e0c171710c6ec30735d06590b7fa8e3c094a9275df1bfddf026f1a94002a000000000000003078373661393566333633313532666133353338623530366362636539333764343138613164643131644100000000000000cba1c56842458c11245ba64b0fc3f93dc90682b12407623634433a6a22a741af356a2df0603ab6d300b7c8638db7c56761a716d4948da10be177b36193c058e7012a0000000000000030783362313836653138643263353530383661343230323338373239613238303761393364366163633941000000000000000727955db4413d3c7f476d94d7570ae6d6ed4177fff682fde08ee21b1e46e47073d39d22218b55bb56e1e620fb4a5f17c998d9b80892a27fd73d947756483085001002f901e5826d7bb9010000000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000040000000000000000000000000080000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000080000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000400000000000000000000000000000000000000000000000000000000000000000f8dbf8d99473552bc4e960a1d53013b40074569ea05b950b4de1a002d96cafa1b66d774136b3051a7a5675d5cb23a055bfe1410019ec924f4f93acb8a00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d00000000000000000000000000000000000000000000000000000000ec90a79a0000000000000000000000000000000000000000000000000000000000000000c001c0f9012c31808398967f9473552bc4e960a1d53013b40074569ea05b950b4d80b8644c6e5926000000000000000000000000000000000000000000000000000000000000000000000000000000000000000073552bc4e960a1d53013b40074569ea05b950b4d000000000000000000000000000000000000000000000000000000000000000281aeb84182e91042d0201d5f3c8def6f7b09a46a02c6d4a9890e878406498f47fc78719a6d86ee0cfb7bba33228649790c7340ea975dbe59b7fd6a0f267de972b1008dbf0180a037f1261203d7b81a5a5cfc4a5c4abf15297555a47fd8686580d5a211876516c4b840c7561cde2792e85c76bf423cf9c339bd085f6ca686e2fe5cb5092c6bff210786790cac0bf6472e6837282bef5e19416e791f5dbf6abbb33e04e4b291d6ef4e1b80"
# python send_tx.py
# python get_receipt.py
{
  "contractAddress": null,
  "cumulativeGasUsed": "0xf9bc",
  "logs": [
    {
      "blockHash": "0x4db09cf2bd71c4fe44add68432ee0d0c5d3f4b98413662be95bebf9644e4eb9d",
      "transactionHash": "0x5ab10d1df914d440b63749bab2e7786d8486d18972bbc1973c303a6ffea633e2",
      "transactionIndex": "0x0",
      "topics": [
        "0x9c312d9fd3ecd3b5e58f9cd24950559f7765c7ee98e7e7783a61efb8ee696ad5"
      ],
      "blockNumber": "0xc5",
      "address": "0x73552bc4e960a1d53013b40074569ea05b950b4d",
      "transactionLogIndex": "0x0",
      "logIndex": "0x0",
      "data": "0x0000000000000000000000000dbd369a741319fa5107733e2c9db9929093e3c7000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000020000000000000000000000000000000000000000000000000000000000000000"
    }
  ],
  "blockHash": "0x4db09cf2bd71c4fe44add68432ee0d0c5d3f4b98413662be95bebf9644e4eb9d",
  "transactionHash": "0x5ab10d1df914d440b63749bab2e7786d8486d18972bbc1973c303a6ffea633e2",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0xc5",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000080000000000000000000000040000000000000002000000000000000000002000000000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0xf9bc"
}
```

### 验证跨链是否成功

查询一下当前用户的token数量。
```shell
//call get_banlance
# curl -X POST --data '{"jsonrpc":"2.0","method":"eth_call", "params":[{"from":"0dbd369a741319fa5107733e2c9db9929093e3c7","to":"0x73552bc4e960a1d53013b40074569ea05b950b4d","data":"0xf74071780000000000000000000000000dbd369a741319fa5107733e2c9db9929093e3c7"}],"id":2}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000064"}
```
转走的2个token又回来了，数量恢复为100个。

查询目标链上对应合约的nonce值。

```shell
//call get_cross_chain_nonce
curl -X POST --data '{"jsonrpc":"2.0","method":"eth_call", "params":[{"from":"0dbd369a741319fa5107733e2c9db9929093e3c7","to":"0x73552bc4e960a1d53013b40074569ea05b950b4d","data":"0x5999917c"}],"id":2}' http://127.0.0.1:1337
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000001"}
```
`nonce`已经增加到1，说明已经接收到了一个跨链交易。

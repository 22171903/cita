# 智能合约指南

## 简介

关于智能合约的概念见[智能合约](https://cryptape.github.io/cita/zh/key-concepts/blockchain/index.html#_3).

本文是关于智能合约在`CITA`上的部署及使用指南。

## 编写智能合约

本文以`Solidity`编写智能合约为例，合约`HelloWorld.sol`的代码如下：

```solidity
pragma solidity ^0.4.19;


contract HelloWorld {
    uint public balance;

    function update(uint amount) public returns (address, uint) {
        balance += amount;
        return (msg.sender, balance);
    }
}
```

一些简要的说明如下：

* `uint public balance`: 表示声明了一个状态变量，类型为 `uint`（即 256 位的无符号整数）。
* `function update(uint amount) public returns (address, uint)`: 表示一个函数，该函数的功能是更新 `HelloWord` 合约的 `balance` ，即调用此函数成功执行后，将增加 `balance` 余额。
    - 其中参数为 `amount` 
    - 返回值为`(address, unit)` ，可以只给出类型，而无需具体的变量名。

更详细的说明可参考[Solidity 官方开发指南](http://solidity.readthedocs.io/en/develop/)。

## 编译合约

首先需要安装`Solidity`编译器，安装编译器有多种不同的方法，推荐安装 `solc` 稳定版，在`Ubuntu 16.04`环境下具体操作如下：

```bash
sudo add-apt-repository ppa:ethereum/ethereum
sudo apt-get update
sudo apt-get install solc
```

更详细的介绍可参考[安装Solidity编译器](http://solidity.readthedocs.io/en/develop/installing-solidity.html)。

然后使用`sloc`将合约编译成字节码：

```bash
solc HelloWorld.sol --bin
```

输出如下：

```bash
======= HelloWorld.sol:HelloWorld =======
Binary:
6060604052341561000f57600080fd5b6101358061001e6000396000f30060606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806382ab890a14610051578063b69ef8a8146100bb575b600080fd5b341561005c57600080fd5b61007260048080359060200190919050506100e4565b604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390f35b34156100c657600080fd5b6100ce610103565b6040518082815260200191505060405180910390f35b6000808260008082825401925050819055503360005491509150915091565b600054815600a165627a7a72305820db4e6428e650152a267ad58bf3e2c67a1a5f652a6fd26d77b10f9573f7eaab490029
```

生成智能合约函数的`Hash`值的命令如下：

```bash
solc HelloWorld.sol --hashes
```

输出如下：

```bash
======= HelloWorld.sol:HelloWorld =======
Function signatures:
b69ef8a8: balance()
82ab890a: update(uint256)
```

## 部署合约

使用[交易相关的工具](https://cryptape.github.io/cita/zh/usage-guide/txtool/index.html#_5)来进行部署合约的操作。

### 构造交易

使用`make_tx.py`来构造部署合约的交易，其中参数`--code`为上文通过`solc HelloWorld.sol --bin`生成的字节码。

```bash
python3 make_tx.py --code '6060604052341561000f57600080fd5b6101358061001e6000396000f30060606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806382ab890a14610051578063b69ef8a8146100bb575b600080fd5b341561005c57600080fd5b61007260048080359060200190919050506100e4565b604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390f35b34156100c657600080fd5b6100ce610103565b6040518082815260200191505060405180910390f35b6000808260008082825401925050819055503360005491509150915091565b600054815600a165627a7a72305820db4e6428e650152a267ad58bf3e2c67a1a5f652a6fd26d77b10f9573f7eaab490029'
```

输出信息如下：

```bash
unverify_tx is 0ae60212013018fface20420fe0c2ad3026060604052341561000f57600080fd5b6101358061001e6000396000f30060606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806382ab890a14610051578063b69ef8a8146100bb575b600080fd5b341561005c57600080fd5b61007260048080359060200190919050506100e4565b604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390f35b34156100c657600080fd5b6100ce610103565b6040518082815260200191505060405180910390f35b6000808260008082825401925050819055503360005491509150915091565b600054815600a165627a7a72305820db4e6428e650152a267ad58bf3e2c67a1a5f652a6fd26d77b10f9573f7eaab49002938969ffe1c1241e56d06ba9398d9be587ebb562a5844200ee9a8d9eb5c1f064912e59e4fc56c732947c6de26af25f1490c2aeaab40b58b6bf8bf39ce1be174b679f1d782b7381e01
```

### 发送交易

使用`send_tx.py`来发送部署合约的交易

```bash
python3 send_tx.py
```

输出信息如下：

```bash
--> {"params": ["0ae60212013018fface20420fe0c2ad3026060604052341561000f57600080fd5b6101358061001e6000396000f30060606040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806382ab890a14610051578063b69ef8a8146100bb575b600080fd5b341561005c57600080fd5b61007260048080359060200190919050506100e4565b604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018281526020019250505060405180910390f35b34156100c657600080fd5b6100ce610103565b6040518082815260200191505060405180910390f35b6000808260008082825401925050819055503360005491509150915091565b600054815600a165627a7a72305820db4e6428e650152a267ad58bf3e2c67a1a5f652a6fd26d77b10f9573f7eaab49002938969ffe1c1241e56d06ba9398d9be587ebb562a5844200ee9a8d9eb5c1f064912e59e4fc56c732947c6de26af25f1490c2aeaab40b58b6bf8bf39ce1be174b679f1d782b7381e01"], "jsonrpc": "2.0", "method": "sendRawTransaction", "id": 1}
<-- {"jsonrpc":"2.0","id":1,"result":{"hash":"0x49223cac085f6324ee720d1cae9eda3732966071437aa47ae98ee2afac9ecabb","status":"OK"}} (200 OK)
```

其中`status`为`OK`表示发送成功。

### 获取回执

使用`get_receipt.py`来获得交易的回执信息，部署合约的地址即在`contractAddress`字段中

```bash
python3 get_receipt.py 
```

输出信息如下：

```bash
--> {"params": ["0x49223cac085f6324ee720d1cae9eda3732966071437aa47ae98ee2afac9ecabb"], "jsonrpc": "2.0", "method": "getTransactionReceipt", "id": 1}
<-- {"jsonrpc":"2.0","id":1,"result":{"transactionHash":"0x49223cac085f6324ee720d1cae9eda3732966071437aa47ae98ee2afac9ecabb","transactionIndex":"0x0","blockHash":"0xfc896770ab30bad5555df80fee5f9d0a40688c3f5dbb0bd9ebbfab384dd3f3c1","blockNumber":"0x634","cumulativeGasUsed":"0xf236","gasUsed":"0xf236","contractAddress":"0x083d8a7adf09dad1d635d70168da09c9ca4e50e7","logs":[],"root":null,"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","errorMessage":null}} (200 OK)
{
  "contractAddress": "0x083d8a7adf09dad1d635d70168da09c9ca4e50e7",
  "cumulativeGasUsed": "0xf236",
  "logs": [],
  "blockHash": "0xfc896770ab30bad5555df80fee5f9d0a40688c3f5dbb0bd9ebbfab384dd3f3c1",
  "transactionHash": "0x49223cac085f6324ee720d1cae9eda3732966071437aa47ae98ee2afac9ecabb",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x634",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0xf236"
}
```

其中，`errorMessage`为`null`表示交易已经上链。

合约部署的地址为`0x083d8a7adf09dad1d635d70168da09c9ca4e50e7`

## 调用合约

同样通过发交易来调用合约中的`update`函数，通过[JSON-RPC](https://cryptape.github.io/cita/zh/usage-guide/rpc/index.html#call)的`call`方法来验证`balance`的值。

### 查询`balance`

运行：

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0x083d8a7adf09dad1d635d70168da09c9ca4e50e7", "data":"0xb69ef8a8"}, "latest"],"id":2}' 127.0.0.1:1337
```

输出信息如下：

```bash
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000000"}
```

其中`balance`值为`0x0000000000000000000000000000000000000000000000000000000000000000`

### 构造交易

使用`make_tx.py`来构造部署合约的交易，其中参数`--code`为[ABI](https://github.com/ethereum/wiki/wiki/Ethereum-Contract-ABI)格式的函数签名及其参数。本示例中参数`amount`设置为`1`。

```bash
python3 make_tx.py --to "0x083d8a7adf09dad1d635d70168da09c9ca4e50e7" --code "82ab890a0000000000000000000000000000000000000000000000000000000000000001"
```

输出信息如下：

```
unverify_tx is 0a600a283038336438613761646630396461643164363335643730313638646130396339636134653530653712013018fface204209e0f2a2482ab890a000000000000000000000000000000000000000000000000000000000000000138969ffe1c1241335d455246a18f08fc14ac2699945879aca5fa717919265cb74d266f2d8109f205d9056799dff0294af7c0ad7cb25a19b090ad2097fd47978fccb14a8889344801
save deploy code to ../output/transaction/deploycode
```
### 发送交易

使用`send_tx.py`来发送调用`update`的交易

```bash
python3 send_tx.py
```

输出信息如下：

```bash
--> {"params": ["0a600a283038336438613761646630396461643164363335643730313638646130396339636134653530653712013018fface204209e0f2a2482ab890a000000000000000000000000000000000000000000000000000000000000000138969ffe1c1241335d455246a18f08fc14ac2699945879aca5fa717919265cb74d266f2d8109f205d9056799dff0294af7c0ad7cb25a19b090ad2097fd47978fccb14a8889344801"], "jsonrpc": "2.0", "method": "sendRawTransaction", "id": 1}
<-- {"jsonrpc":"2.0","id":1,"result":{"hash":"0xdd26cff93b5e9360cd65ce82ddc73def4b949bb9df36fa058bb7dcc23c77c269","status":"OK"}} (200 OK)
```

其中`status`为`OK`表示发送成功。

### 获取回执

使用`get_receipt.py`来获得交易的回执信息。

```bash
python3 get_receipt.py 
```

输出信息如下：

```bash
--> {"params": ["0xdd26cff93b5e9360cd65ce82ddc73def4b949bb9df36fa058bb7dcc23c77c269"], "jsonrpc": "2.0", "method": "getTransactionReceipt", "id": 1}
<-- {"jsonrpc":"2.0","id":1,"result":{"transactionHash":"0xdd26cff93b5e9360cd65ce82ddc73def4b949bb9df36fa058bb7dcc23c77c269","transactionIndex":"0x0","blockHash":"0xea8612343e60626a141c80f5867c0b516e7086e441bcd285fac097e249908cf3","blockNumber":"0x774","cumulativeGasUsed":"0x501c","gasUsed":"0x501c","contractAddress":null,"logs":[],"root":null,"logsBloom":"0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000","errorMessage":null}} (200 OK)
{
  "contractAddress": null,
  "cumulativeGasUsed": "0x501c",
  "logs": [],
  "blockHash": "0xea8612343e60626a141c80f5867c0b516e7086e441bcd285fac097e249908cf3",
  "transactionHash": "0xdd26cff93b5e9360cd65ce82ddc73def4b949bb9df36fa058bb7dcc23c77c269",
  "root": null,
  "errorMessage": null,
  "blockNumber": "0x774",
  "logsBloom": "0x00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000",
  "transactionIndex": "0x0",
  "gasUsed": "0x501c"
}
```

其中，`errorMessage`为`null`表示交易已经上链。

### 再次查询`balance`

运行：

```
curl -X POST --data '{"jsonrpc":"2.0","method":"call", "params":[{"to":"0x083d8a7adf09dad1d635d70168da09c9ca4e50e7", "data":"0xb69ef8a8"}, "latest"],"id":2}' 127.0.0.1:1337
```

输出信息如下：

```bash
{"jsonrpc":"2.0","id":2,"result":"0x0000000000000000000000000000000000000000000000000000000000000001"}
```

其中`balance`值为`0x0000000000000000000000000000000000000000000000000000000000000001`，`update`更新成功。
